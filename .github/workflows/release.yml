name: ðŸš€ Release and Publish

on:
  push:
    branches:
      - main
    paths:
      - "src/DLLPickle/**"
      - "!src/Archive/**"
      - "!src/Artifacts/**"
      - "!**.md"
  workflow_dispatch:
    inputs:
      version_bump:
        description: "Version bump type (major, minor, patch) - overrides conventional commit analysis"
        required: false
        type: choice
        options:
          - auto
          - major
          - minor
          - patch

# Prevent concurrent releases
concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: read

env:
  MODULE_NAME: DLLPickle
  MODULE_DIR: ./src/DLLPickle
  MANIFEST_PATH: ./src/DLLPickle/DLLPickle.psd1

jobs:
  analyze:
    name: Analyze and Determine Version
    runs-on: ubuntu-latest
    # Skip if commit message contains [skip-release] or [no-release]
    if: |
      !contains(github.event.head_commit.message, '[skip-release]') &&
      !contains(github.event.head_commit.message, '[no-release]') &&
      github.repository_owner == 'SamErde'

    outputs:
      should_release: ${{ steps.determine_version.outputs.should_release }}
      version_bump: ${{ steps.determine_version.outputs.version_bump }}
      current_version: ${{ steps.determine_version.outputs.current_version }}
      new_version: ${{ steps.determine_version.outputs.new_version }}
      trigger_source: ${{ steps.determine_version.outputs.trigger_source }}

    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: Determine version and bump type
        id: determine_version
        shell: pwsh
        env:
          EVENT_NAME: ${{ github.event_name }}
          MANUAL_BUMP: ${{ inputs.version_bump }}
        run: |
          # Determine trigger source
          if ($env:EVENT_NAME -eq "workflow_dispatch") {
              $triggerSource = "manual"
          } else {
              $triggerSource = "push"
          }
          Write-Host "Trigger source: $triggerSource"

          # If manual dispatch with explicit version bump, use that
          if ($triggerSource -eq "manual" -and $env:MANUAL_BUMP -ne "auto" -and -not [string]::IsNullOrEmpty($env:MANUAL_BUMP)) {
              Write-Host "Manual version bump specified: $($env:MANUAL_BUMP)"
              $versionBump = $env:MANUAL_BUMP
              $shouldRelease = $true
          } else {
              # Analyze conventional commits to determine version
              Write-Host "Analyzing conventional commits..."
              $versionResult = & .\.github\scripts\Get-VersionBump.ps1

              $shouldRelease = $versionResult.ShouldRelease
              $versionBump = $versionResult.VersionBump
              $newVersion = $versionResult.NewVersion
              $currentVersion = $versionResult.NewVersion.ToString()
          }

          # If we're doing semantic analysis (not manual explicit), get the versions from the script result
          if ($triggerSource -eq "push" -or ($triggerSource -eq "manual" -and $env:MANUAL_BUMP -eq "auto")) {
              if (-not $shouldRelease) {
                  Write-Host "No release needed based on commit analysis"
                  "should_release=false" >> $env:GITHUB_OUTPUT
                  "trigger_source=$triggerSource" >> $env:GITHUB_OUTPUT
                  exit 0
              }
          } else {
              # For manual dispatch with explicit bump, we always release
              $manifest = Import-PowerShellDataFile -Path $env:MANIFEST_PATH
              $currentVersion = [version]$manifest.ModuleVersion

              switch ($versionBump) {
                  "major" { $newVersion = [version]::new($currentVersion.Major + 1, 0, 0) }
                  "minor" { $newVersion = [version]::new($currentVersion.Major, $currentVersion.Minor + 1, 0) }
                  "patch" { $newVersion = [version]::new($currentVersion.Major, $currentVersion.Minor, $currentVersion.Build + 1) }
              }
          }

          Write-Host "Version bump: $versionBump"
          Write-Host "Current version: $currentVersion"
          Write-Host "New version: $newVersion"

          "should_release=true" >> $env:GITHUB_OUTPUT
          "version_bump=$versionBump" >> $env:GITHUB_OUTPUT
          "current_version=$currentVersion" >> $env:GITHUB_OUTPUT
          "new_version=$newVersion" >> $env:GITHUB_OUTPUT
          "trigger_source=$triggerSource" >> $env:GITHUB_OUTPUT

      - name: Display release plan
        if: steps.determine_version.outputs.should_release == 'true'
        shell: pwsh
        run: |
          $summary = @"
          ## ðŸ“‹ Release Plan

          **Trigger:** ${{ steps.determine_version.outputs.trigger_source }}
          **Version Bump:** ${{ steps.determine_version.outputs.version_bump }}
          **Version:** ${{ steps.determine_version.outputs.current_version }} â†’ ${{ steps.determine_version.outputs.new_version }}

          ### Steps
          1. âœ“ Analyzed version requirements
          2. â†’ Update module manifest
          3. â†’ Build and test
          4. â†’ Create GitHub release
          5. â†’ Publish to PSGallery
          "@

          Write-Host $summary
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value $summary

  update-version:
    name: Update Module Version
    runs-on: ubuntu-latest
    needs: analyze
    if: needs.analyze.outputs.should_release == 'true'

    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          token: ${{ secrets.PAT_TOKEN }}
          fetch-depth: 0

      - name: Update module manifest version
        shell: pwsh
        run: |
          $updateResult = & .\.github\scripts\Update-ModuleVersion.ps1 `
            -ManifestPath $env:MANIFEST_PATH `
            -NewVersion "${{ needs.analyze.outputs.new_version }}"

          if (-not $updateResult.Success) {
              Write-Error "Failed to update module manifest: $($updateResult.ErrorMessage)"
              exit 1
          }

      - name: Commit version update
        shell: pwsh
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add $env:MANIFEST_PATH
          git commit -m "chore(release): bump version to ${{ needs.analyze.outputs.new_version }}"
          git push origin HEAD:main

          if ($LASTEXITCODE -ne 0) {
              Write-Error "Failed to push version update to main"
              exit 1
          }

      - name: Create version tag
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          $version = "${{ needs.analyze.outputs.new_version }}"
          $tagName = "v$version"

          Write-Host "Creating tag: $tagName"

          # Get the commit SHA we just created
          $commitSha = git rev-parse HEAD

          # Create and push the tag
          git tag -a $tagName -m "Release $version" $commitSha
          git push origin $tagName

          if ($LASTEXITCODE -ne 0) {
              Write-Error "Failed to create and push tag"
              exit 1
          }

          Write-Host "âœ“ Tag created: $tagName"

  build-and-test:
    name: Build and Test Module
    runs-on: ubuntu-latest
    needs: update-version

    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Checkout repository (with new tag)
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: Cache PowerShell modules
        uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb # v5.0.1
        with:
          path: |
            ~/.local/share/powershell/Modules
          key: ${{ runner.os }}-psmodules-${{ hashFiles('src/DLLPickle.build.ps1') }}

      - name: Bootstrap
        shell: pwsh
        run: ./.github/scripts/Actions_Bootstrap.ps1

      - name: Build and Test Module
        shell: pwsh
        run: |
          try {
              Invoke-Build -File ./src/DLLPickle.Build.ps1
              Write-Host "âœ“ Build and tests passed" -ForegroundColor Green
          }
          catch {
              Write-Error "Build failed: $_"
              exit 1
          }

      - name: Upload build artifacts
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: build-artifacts-${{ github.run_number }}
          path: ./src/Archive
          if-no-files-found: warn

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [analyze, update-version, build-and-test]

    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: Check if release already exists
        id: check_release
        shell: pwsh
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          $version = "${{ needs.analyze.outputs.new_version }}"
          $tagName = "v$version"

          try {
              $release = gh release view $tagName --json id 2>$null
              if ($release) {
                  Write-Host "Release $tagName already exists"
                  "exists=true" >> $env:GITHUB_OUTPUT
              } else {
                  Write-Host "Release $tagName does not exist yet"
                  "exists=false" >> $env:GITHUB_OUTPUT
              }
          }
          catch {
              Write-Host "Release $tagName does not exist"
              "exists=false" >> $env:GITHUB_OUTPUT
          }

      - name: Generate release notes
        id: release_notes
        if: steps.check_release.outputs.exists == 'false'
        shell: pwsh
        run: |
          $version = "${{ needs.analyze.outputs.new_version }}"
          $lastTag = git describe --tags --abbrev=0 2>$null

          if ($lastTag) {
              $commits = git log "$lastTag..HEAD" --oneline --no-decorate
          } else {
              $commits = git log --oneline --no-decorate | head -20
          }

          $releaseNotes = @"
          ## Changes in v$version

          **Version Bump:** ${{ needs.analyze.outputs.version_bump }}
          **Triggered by:** ${{ needs.analyze.outputs.trigger_source }}

          ### Recent Commits
          ``````
          $commits
          ``````

          ### Links
          - **PowerShell Gallery:** https://www.powershellgallery.com/packages/${{ env.MODULE_NAME }}/$version
          - **View on GitHub:** https://github.com/${{ github.repository }}/releases/tag/v$version

          ---
          *Released by GitHub Actions*
          "@

          # Encode for safe output passing
          $encodedNotes = [Convert]::ToBase64String([Text.Encoding]::UTF8.GetBytes($releaseNotes))
          "notes_base64=$encodedNotes" >> $env:GITHUB_OUTPUT

      - name: Create GitHub release
        if: steps.check_release.outputs.exists == 'false'
        shell: pwsh
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          $version = "${{ needs.analyze.outputs.new_version }}"
          $tagName = "v$version"

          # Decode the release notes
          $encodedNotes = "${{ steps.release_notes.outputs.notes_base64 }}"
          $releaseNotes = [Text.Encoding]::UTF8.GetString([Convert]::FromBase64String($encodedNotes))

          Write-Host "Creating release for $tagName"

          # Create the release
          gh release create $tagName `
            --title "Release $version" `
            --notes $releaseNotes `
            --draft=false `
            --prerelease=false

          if ($LASTEXITCODE -ne 0) {
              Write-Error "Failed to create GitHub release"
              exit 1
          }

          Write-Host "âœ“ GitHub release created: $tagName"

  publish:
    name: Publish to PowerShell Gallery
    runs-on: ubuntu-latest
    needs: [analyze, create-release]
    environment:
      name: psgallery
      url: https://www.powershellgallery.com/packages/${{ env.MODULE_NAME }}

    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Verify version to publish
        shell: pwsh
        run: |
          $manifest = Import-PowerShellDataFile -Path $env:MANIFEST_PATH
          $manifestVersion = $manifest.ModuleVersion
          $expectedVersion = "${{ needs.analyze.outputs.new_version }}"

          if ($manifestVersion -ne $expectedVersion) {
              Write-Error "Version mismatch: manifest has $manifestVersion but expected $expectedVersion"
              exit 1
          }

          Write-Host "âœ“ Version verified: $manifestVersion"

      - name: Check if version already published
        id: check_published
        shell: pwsh
        run: |
          $version = "${{ needs.analyze.outputs.new_version }}"

          try {
              Set-PSRepository -Name PSGallery -InstallationPolicy Trusted -ErrorAction SilentlyContinue
             # Create the release (tag should already exist from update-version job)
             Write-Host "Attempting to create release with tag: $tagName"

             $output = gh release create $tagName `
               --title "Release $version" `
               --notes $releaseNotes `
               --draft=false `
               --prerelease=false 2>&1

             if ($LASTEXITCODE -ne 0) {
                 Write-Host "Error output: $output"
                 Write-Host "Exit code: $LASTEXITCODE"
                 Write-Error "Failed to create GitHub release"
                 exit 1
             }
              Write-Host "Could not check PSGallery, assuming not published"
              "already_published=false" >> $env:GITHUB_OUTPUT
          }

      - name: Publish to PowerShell Gallery
        if: steps.check_published.outputs.already_published == 'false'
        shell: pwsh
        env:
          PSGALLERY_API_KEY: ${{ secrets.PSGALLERY_API_KEY }}
        run: |
          if ([string]::IsNullOrWhiteSpace($env:PSGALLERY_API_KEY)) {
              Write-Error "PSGALLERY_API_KEY secret is not configured"
              exit 1
          }

          $publishResult = & .\.github\scripts\Publish-ToGallery.ps1 `
            -ModuleDirectory $env:MODULE_DIR `
            -ApiKey $env:PSGALLERY_API_KEY

          if (-not $publishResult.Success) {
              Write-Error "Publishing failed: $($publishResult.Message)`nError: $($publishResult.ErrorMessage)"
              exit 1
          }

          Write-Host "âœ“ Module published successfully"
          Write-Host "Gallery URL: $($publishResult.GalleryUrl)"

  summary:
    name: Release Summary
    runs-on: ubuntu-latest
    needs: [analyze, update-version, build-and-test, create-release, publish]
    if: always()

    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Generate summary
        shell: pwsh
        run: |
          $summary = @"
          ## ðŸŽ‰ Release Complete

          **Module:** ${{ env.MODULE_NAME }}
          **Version:** ${{ needs.analyze.outputs.new_version }}
          **Bump Type:** ${{ needs.analyze.outputs.version_bump }}
          **Trigger:** ${{ needs.analyze.outputs.trigger_source }}

          ### Workflow Status
          | Step | Status |
          |------|--------|
          | Analyze | ${{ needs.analyze.result }} |
          | Update Version | ${{ needs.update-version.result }} |
          | Build & Test | ${{ needs.build-and-test.result }} |
          | Create Release | ${{ needs.create-release.result }} |
          | Publish | ${{ needs.publish.result }} |

          ### Links
          - **Release:** https://github.com/${{ github.repository }}/releases/tag/v${{ needs.analyze.outputs.new_version }}
          - **Gallery:** https://www.powershellgallery.com/packages/${{ env.MODULE_NAME }}/${{ needs.analyze.outputs.new_version }}
          - **Workflow Run:** https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

          ---
          _Released by: @${{ github.actor }}_
          "@

          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value $summary
