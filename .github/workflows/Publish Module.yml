# This workflow publishes the PowerShell module to the PowerShell Gallery and
# creates a GitHub release if one doesn't already exist for the module version.
#
# Workflow steps:
# 1. Validates the module manifest and extracts version information
# 2. Publishes the module to PowerShell Gallery
# 3. Checks if a GitHub release exists for the module version
# 4. Creates a GitHub release if none exists (with tag v{version})
#
# Triggers:
# - Manual workflow dispatch (for ad-hoc publishes)
# - When a GitHub release is published (in case a different workflow creates the GitHub release)
name: Publish Module to PowerShell Gallery

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Module version to publish (optional, uses manifest if not provided)'
        required: false

concurrency:
  group: publish-psgallery-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write # Create GitHub releases and artifacts

jobs:
  publish:
    name: Publish Module to PowerShell Gallery
    runs-on: ubuntu-latest
    environment:
      name: psgallery
      url: https://www.powershellgallery.com/packages/${{ steps.manifest.outputs.name || 'DLLPickle' }}
    env:
      MODULE_DIR: ./src/DLLPickle
      MANIFEST: ./src/DLLPickle/DLLPickle.psd1
      ARTIFACT_DIR: ./artifacts

    steps:
      - name: Harden the Runner (Audit All Outbound Calls)
        uses: step-security/harden-runner@df199fb7be9f65074067a9eb93f12bb4c5547cf2 # v2.13.3
        with:
          egress-policy: audit

      - name: Checkout Repository Code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Setup PowerShell Environment
        shell: pwsh
        run: |
          Write-Host "PowerShell Version: $($PSVersionTable.PSVersion)"
          Write-Host "Platform: $($PSVersionTable.Platform)"
          Set-PSRepository -Name PSGallery -InstallationPolicy Trusted

      - name: Validate Manifest & Version
        id: manifest
        shell: pwsh
        run: |
          # Validate module manifest
          $manifestPath = $env:MANIFEST
          Write-Host "Validating module manifest: $manifestPath"
          $manifest = Test-ModuleManifest -Path $manifestPath -ErrorAction Stop
          $manifestContent = Get-Content $manifestPath -Raw

          # Check if prerelease module and get the full version as a string
          $isPrerelease = $false # Set default as not prerelease
          if ($manifestContent -match "Prerelease\s*=\s*'([^']+)'") {
            $prerelease = $Matches[1]
            $isPrerelease = $true
            $fullVersion = "$( $manifest.Version )-$prerelease"
            Write-Host "Prerelease tag: $prerelease"
          } else {
            $fullVersion = $manifest.Version.ToString()
            Write-Host "Stable release detected"
          }
          Write-Host "Full version resolved: $fullVersion"

          # Check if version already exists in PSGallery
          Write-Host "Checking if version $fullVersion is already published..."
          try {
            $existing = Find-Module -Name DLLPickle -RequiredVersion $fullVersion -ErrorAction SilentlyContinue
            if ($existing) {
              Write-Error "Version $fullVersion is already published to PowerShell Gallery. Please update the module version."
              # exit 1 # Commented out to allow proceeding even if version exists so the GitHub release can still be created, if needed.
            }
            Write-Host "Version $fullVersion is not yet published. Proceeding..."
          } catch {
            Write-Host "Version check encountered an exception but will proceed: $($_.Exception.Message)"
          }

          # Determine the GitHub release tag and normalized version
          $releaseTag = ''
          $releaseVersion = ''
          if ($env:GITHUB_EVENT_NAME -eq 'release') {
            $releaseTag = $env:GITHUB_REF -replace 'refs/tags/', ''
            $releaseVersion = $releaseTag -replace '^v', ''
            Write-Host "Release tag: $releaseTag"
            Write-Host "Release version (normalized): $releaseVersion"
          }

          # Check alignment of GitHub release tag/version with module version
          $tagVersion = $releaseVersion # normalized tag version
          $moduleVersion = $fullVersion
          $versions = @($releaseVersion, $tagVersion, $moduleVersion) | Where-Object { $_ } | Select-Object -Unique
          if ($versions.Count -gt 1) {
            Write-Warning "Mismatch detected among release version, tag version, and module version: ReleaseVersion='$releaseVersion' TagVersion='$tagVersion' ModuleVersion='$moduleVersion'"
          } else {
            if ($releaseVersion) { Write-Host "âœ“ Release, tag, and module versions align: $moduleVersion" }
          }

          # Emit outputs
          echo "name=$($manifest.Name)" >> $env:GITHUB_OUTPUT
          echo "baseVersion=$($manifest.Version)" >> $env:GITHUB_OUTPUT
          echo "fullVersion=$fullVersion" >> $env:GITHUB_OUTPUT
          echo "isPrerelease=$isPrerelease" >> $env:GITHUB_OUTPUT
          echo "releaseTag=$releaseTag" >> $env:GITHUB_OUTPUT
          echo "releaseVersion=$releaseVersion" >> $env:GITHUB_OUTPUT

      - name: Install Dependencies
        shell: pwsh
        run: |
          Write-Host "Ensuring PowerShellGet minimum version..."
          $psGetVersion = (Get-Module -Name PowerShellGet -ListAvailable | Sort-Object Version -Descending | Select-Object -First 1).Version
          Write-Host "Current PowerShellGet version: $psGetVersion"

          if (-not $psGetVersion -or $psGetVersion -lt [version]'2.2.5') {
            Write-Host "Installing PowerShellGet 2.2.5 or later..."
            Install-Module -Name PowerShellGet -MinimumVersion 2.2.5 -Force -Scope CurrentUser -AllowClobber
          }
          Import-Module PowerShellGet -MinimumVersion 2.2.5

      - name: Publish Module to PowerShell Gallery
        shell: pwsh
        env:
          PSGALLERY_API_KEY: ${{ secrets.PSGALLERY_API_KEY }}
          MODULE_NAME: ${{ steps.manifest.outputs.name }}
          MODULE_VERSION: ${{ steps.manifest.outputs.fullVersion }}
        run: |
          $ErrorActionPreference = 'Stop'
          if ([string]::IsNullOrWhiteSpace($env:PSGALLERY_API_KEY)) { Write-Error "PSGALLERY_API_KEY secret is not set."; exit 1 }

          Write-Host "Preparing to publish module: $env:MODULE_NAME"
          Write-Host "Version (full): $env:MODULE_VERSION"

          Set-PSRepository -Name PSGallery -InstallationPolicy Trusted -ErrorAction SilentlyContinue

          $publishParams = @{
            Path        = $env:MODULE_DIR
            NuGetApiKey = $env:PSGALLERY_API_KEY
            Repository  = 'PSGallery'
            Verbose     = $true
            Force       = $true
          }

          Write-Host "Publishing module to PowerShell Gallery..." -ForegroundColor Green
          # Implement retry logic for publishing
          $maxRetries = 3; $retryCount = 0; $publishSuccess = $false
          while (-not $publishSuccess -and $retryCount -lt $maxRetries) {
            try {
              if ($retryCount -gt 0) { Write-Host "Retry attempt $retryCount of $maxRetries..."; Start-Sleep -Seconds (5 * $retryCount) }
              Publish-Module @publishParams
              $publishSuccess = $true
              Write-Host "\nâœ“ Module published successfully!" -ForegroundColor Green
              Write-Host "View at: https://www.powershellgallery.com/packages/$env:MODULE_NAME/$env:MODULE_VERSION"
            } catch {
              $retryCount++
              if ($retryCount -ge $maxRetries) { Write-Error "Failed to publish module after $maxRetries attempts: $_"; Write-Host "Error details: $($_.Exception.Message)"; exit 1 }
              Write-Warning "Publish attempt failed: $($_.Exception.Message)"
            }
          }

          Start-Sleep -Seconds 30  # Allow PSGallery indexing
          $published = Find-Module -Name $env:MODULE_NAME -RequiredVersion $env:MODULE_VERSION -AllowPrerelease -ErrorAction SilentlyContinue
          if (-not $published) { Write-Warning "Module published but not yet visible in gallery search." }

      - name: Save Published Module as Artifact (with File Hashes)
        if: success()
        shell: pwsh
        run: |
          $artifactPath = $env:ARTIFACT_DIR
          New-Item -Path $artifactPath -ItemType Directory -Force | Out-Null
          Copy-Item -Path $env:MODULE_DIR -Destination "$artifactPath/DLLPickle" -Recurse -Force

          $publishInfo = @{
            ModuleName    = '${{ steps.manifest.outputs.name }}'
            Version       = '${{ steps.manifest.outputs.fullVersion }}'
            BaseVersion   = '${{ steps.manifest.outputs.baseVersion }}'
            IsPrerelease  = '${{ steps.manifest.outputs.isPrerelease }}'
            ReleaseTag    = '${{ steps.manifest.outputs.releaseTag }}'
            ReleaseVersion= '${{ steps.manifest.outputs.releaseVersion }}'
            PublishedDate = (Get-Date).ToString('o')
            GitHubRef     = $env:GITHUB_REF
            GitHubSha     = $env:GITHUB_SHA
            GitHubRunId   = $env:GITHUB_RUN_ID
            Actor         = $env:GITHUB_ACTOR
            EventName     = $env:GITHUB_EVENT_NAME
          }
          $publishInfo | ConvertTo-Json -Depth 10 | Set-Content "$artifactPath/publish-info.json"

          # File hash stamping for audit/compliance
          $hashes = Get-ChildItem "$artifactPath/DLLPickle" -Recurse -File | ForEach-Object {
            $h = Get-FileHash -Path $_.FullName -Algorithm SHA256
            [PSCustomObject]@{ Path = $_.FullName.Replace($artifactPath,'').TrimStart('/'); Algorithm = $h.Algorithm; Hash = $h.Hash }
          }
          $hashes | ConvertTo-Json -Depth 5 | Set-Content "$artifactPath/file-hashes.json"
          Write-Host "Artifacts and file hashes prepared for upload"

      - name: Upload Module Artifact
        if: success()
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v4
        with:
          name: published-module-${{ github.run_number }}
          path: ${{ env.ARTIFACT_DIR }}/
          retention-days: 30

      - name: Create Summary of Module Publish Steps
        if: success()
        shell: pwsh
        run: |
          $summary = @"
          ## Publish Summary
          Module: ${{ steps.manifest.outputs.name }}
          Version: ${{ steps.manifest.outputs.fullVersion }} (Base: ${{ steps.manifest.outputs.baseVersion }})
          Prerelease: ${{ steps.manifest.outputs.isPrerelease }}
          Release Tag: ${{ steps.manifest.outputs.releaseTag }}
          Release Version: ${{ steps.manifest.outputs.releaseVersion }}
          Run ID: $env:GITHUB_RUN_ID
          Commit: $env:GITHUB_SHA
          Actor: $env:GITHUB_ACTOR
          Event: $env:GITHUB_EVENT_NAME
          Artifact: published-module-${{ github.run_number }}
          "@
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value $summary

      - name: Check for Existing GitHub Release
        if: success()
        id: check-release
        shell: pwsh
        env:
          GH_TOKEN: ${{ github.token }}
          MODULE_VERSION: ${{ steps.manifest.outputs.fullVersion }}
        run: |
          $ErrorActionPreference = 'Continue'
          $releaseTag = "v$env:MODULE_VERSION"
          Write-Host "Checking for existing GitHub release with tag: $releaseTag"

          # Use GitHub CLI to check if release exists with proper error handling
          try {
            $output = gh release view $releaseTag --json tagName 2>&1
            if ($LASTEXITCODE -eq 0) {
              Write-Host "âœ“ Release $releaseTag already exists"
              echo "exists=true" >> $env:GITHUB_OUTPUT
            } else {
              Write-Host "âœ— Release $releaseTag does not exist"
              echo "exists=false" >> $env:GITHUB_OUTPUT
            }
          } catch {
            Write-Host "âœ— Release $releaseTag does not exist (error: $($_.Exception.Message))"
            echo "exists=false" >> $env:GITHUB_OUTPUT
          }

      - name: Create GitHub Release
        if: success() && steps.check-release.outputs.exists == 'false'
        shell: pwsh
        env:
          GH_TOKEN: ${{ github.token }}
          MODULE_NAME: ${{ steps.manifest.outputs.name }}
          MODULE_VERSION: ${{ steps.manifest.outputs.fullVersion }}
          BASE_VERSION: ${{ steps.manifest.outputs.baseVersion }}
          IS_PRERELEASE: ${{ steps.manifest.outputs.isPrerelease }}
        run: |
          $ErrorActionPreference = 'Stop'
          $releaseTag = "v$env:MODULE_VERSION"
          $releaseName = "$env:MODULE_NAME v$env:MODULE_VERSION"

          Write-Host "Creating GitHub release: $releaseName (tag: $releaseTag)"

          # Build release body with module metadata
          # Using a simple string concatenation to avoid YAML escaping issues
          $installCmd = "Install-Module -Name $env:MODULE_NAME -RequiredVersion $env:MODULE_VERSION"
          $releaseBody = "## $env:MODULE_NAME v$env:MODULE_VERSION`n`n"
          $releaseBody += "This release corresponds to version **$env:MODULE_VERSION** published to the PowerShell Gallery.`n`n"
          $releaseBody += "### ðŸ“¦ Installation`n`n"
          $releaseBody += "``````powershell`n$installCmd`n``````n`n"
          $releaseBody += "### ðŸ“‹ Module Information`n"
          $releaseBody += "- **Module Name:** $env:MODULE_NAME`n"
          $releaseBody += "- **Version:** $env:MODULE_VERSION`n"
          $releaseBody += "- **Base Version:** $env:BASE_VERSION`n"
          $releaseBody += "- **Prerelease:** $env:IS_PRERELEASE`n"
          $releaseBody += "- **PowerShell Gallery:** https://www.powershellgallery.com/packages/$env:MODULE_NAME/$env:MODULE_VERSION`n`n"
          $releaseBody += "### ðŸ”— Links`n"
          $releaseBody += "- **Commit:** $env:GITHUB_SHA`n"
          $releaseBody += "- **Workflow Run:** https://github.com/$env:GITHUB_REPOSITORY/actions/runs/$env:GITHUB_RUN_ID`n"
          $releaseBody += "- **Published by:** @$env:GITHUB_ACTOR`n`n"
          $releaseBody += "For detailed changes, see the [CHANGELOG](https://github.com/$env:GITHUB_REPOSITORY/blob/main/CHANGELOG.md)."

          # Create release using GitHub CLI with proper argument handling
          Write-Host "Creating release with tag: $releaseTag"

          if ($env:IS_PRERELEASE -eq 'true') {
            Write-Host "Marking as prerelease"
            gh release create $releaseTag --title $releaseName --notes $releaseBody --prerelease
          } else {
            gh release create $releaseTag --title $releaseName --notes $releaseBody
          }

          if ($LASTEXITCODE -eq 0) {
            Write-Host "âœ“ GitHub release created successfully!" -ForegroundColor Green
            Write-Host "View at: https://github.com/$env:GITHUB_REPOSITORY/releases/tag/$releaseTag"
          } else {
            Write-Error "Failed to create GitHub release"
            exit 1
          }
