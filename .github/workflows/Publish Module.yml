name: Publish Module to PowerShell Gallery

on:
  release:
    types: [published]
  workflow_dispatch:
#    inputs:
#      dry_run:
#        description: 'Run in dry-run mode (do not actually publish)'
#        required: false
#        type: boolean
#        default: true

permissions:
  contents: read

jobs:
  publish:
    name: Publish Module to PowerShell Gallery
    runs-on: ubuntu-latest
    environment:
      name: psgallery
      url: https://www.powershellgallery.com/packages/DLLPickle

    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Setup PowerShell Environment
        shell: pwsh
        run: |
          Write-Host "PowerShell Version: $($PSVersionTable.PSVersion)"
          Write-Host "Platform: $($PSVersionTable.Platform)"

      - name: Validate Module Manifest
        shell: pwsh
        run: |
          $manifestPath = './src/DLLPickle/DLLPickle.psd1'
          Write-Host "Validating module manifest: $manifestPath"
          $manifest = Test-ModuleManifest -Path $manifestPath -ErrorAction Stop

          # Check if this is a prerelease
          $manifestContent = Get-Content $manifestPath -Raw
          if ($manifestContent -match "Prerelease\s*=\s*'([^']+)'") {
            $prerelease = $Matches[1]
            Write-Host "Prerelease tag: $prerelease"
            Write-Host "Full version will be: $($manifest.Version)-$prerelease"
          } else {
            Write-Host "This is a stable release"
          }

      - name: Install Dependencies
        shell: pwsh
        run: |
          Write-Host "Installing required modules..."
          Install-Module -Name PowerShellGet -Force -Scope CurrentUser -AllowClobber
          Import-Module PowerShellGet

      - name: Publish Module to PowerShell Gallery
        shell: pwsh
        env:
          PSGALLERY_API_KEY: ${{ secrets.PSGALLERY_API_KEY }}
        run: |
          $ErrorActionPreference = 'Stop'

          # Verify API key is present
          if ([string]::IsNullOrWhiteSpace($env:PSGALLERY_API_KEY)) {
            Write-Error "PSGALLERY_API_KEY secret is not set. Please configure it in the repository settings."
            exit 1
          }

          $modulePath = './src/DLLPickle'
          $manifestPath = Join-Path $modulePath 'DLLPickle.psd1'

          # Get module information
          $manifest = Test-ModuleManifest -Path $manifestPath
          $version = $manifest.Version

          Write-Host "Preparing to publish module: $($manifest.Name)"
          Write-Host "Version: $version"

          # Prepare publish parameters
          $publishParams = @{
            Path        = $modulePath
            NuGetApiKey = $env:PSGALLERY_API_KEY
            Repository  = 'PSGallery'
            Verbose     = $false
            Force       = $true
          }

          Write-Host "Publishing module to PowerShell Gallery..." -ForegroundColor Green
          try {
            Publish-Module @publishParams
            Write-Host ""
            Write-Host "âœ“ Module published successfully!" -ForegroundColor Green
            Write-Host "View at: https://www.powershellgallery.com/packages/$($manifest.Name)/$version"
          }
          catch {
            Write-Error "Failed to publish module: $_"
            Write-Host "Error details: $($_.Exception.Message)"
            exit 1
          }
