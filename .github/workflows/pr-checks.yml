name: PR Checks

on:
  pull_request:
    branches:
      - main
    paths:
      - 'src/**'
      - '!src/Archive/**'
      - '!src/Artifacts/**'
      - '.github/workflows/**'

# Prevent concurrent runs for the same PR
concurrency:
  group: pr-checks-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  statuses: write

jobs:
        lint:
          name: Lint & Validate
          runs-on: windows-latest

          steps:
            - name: Harden the runner (Audit all outbound calls)
              uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
              with:
                egress-policy: audit

            - name: Checkout repository
              uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
              with:
                fetch-depth: 0

            - name: Cache PowerShell modules
              uses: actions/cache@v4
              with:
                path: |
                  ~\Documents\PowerShell\Modules
                key: ps-modules-${{ runner.os }}-v1
                restore-keys: |
                  ps-modules-${{ runner.os }}-

            - name: Bootstrap dependencies
              uses: ./.github/actions/bootstrap

            - name: Validate module manifest
              shell: pwsh
              run: |
                $manifestPath = "./src/DLLPickle/DLLPickle.psd1"
                Write-Host "Validating module manifest: $manifestPath"

                try {
                    $manifest = Test-ModuleManifest -Path $manifestPath -ErrorAction Stop
                    Write-Host "✓ Module manifest is valid" -ForegroundColor Green
                    Write-Host "  Module: $($manifest.Name)"
                    Write-Host "  Version: $($manifest.Version)"
                    Write-Host "  Author: $($manifest.Author)"
                } catch {
                    Write-Error "Module manifest validation failed: $_"
                    exit 1
                }

            - name: Run PSScriptAnalyzer
              shell: pwsh
              run: |
                # Ensure PSScriptAnalyzer is available
                if (-not (Get-Module -ListAvailable -Name PSScriptAnalyzer)) {
                    Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser
                }

                Import-Module PSScriptAnalyzer

                $settingsPath = "./src/PSScriptAnalyzerSettings.psd1"
                $sourcePath = "./src/DLLPickle"

                Write-Host "Running PSScriptAnalyzer on: $sourcePath"
                if (Test-Path $settingsPath) {
                    Write-Host "Using settings file: $settingsPath"
                    $results = Invoke-ScriptAnalyzer -Path $sourcePath -Settings $settingsPath -Recurse
                } else {
                    $results = Invoke-ScriptAnalyzer -Path $sourcePath -Recurse
                }

                if ($results) {
                    $results | Format-Table -AutoSize
                    $errorCount = ($results | Where-Object { $_.Severity -eq 'Error' }).Count
                    $warningCount = ($results | Where-Object { $_.Severity -eq 'Warning' }).Count

                    Write-Host "`nSummary:"
                    Write-Host "  Errors: $errorCount"
                    Write-Host "  Warnings: $warningCount"

                    if ($errorCount -gt 0) {
                        Write-Error "PSScriptAnalyzer found $errorCount error(s)"
                        exit 1
                    }
                } else {
                    Write-Host "✓ No PSScriptAnalyzer issues found" -ForegroundColor Green
                }

            - name: Check code formatting
              shell: pwsh
              run: |
                Write-Host "Checking PowerShell code formatting..."

                # Check for common formatting issues
                $files = Get-ChildItem -Path ./src/DLLPickle -Include *.ps1,*.psm1 -Recurse
                $issues = @()

                foreach ($file in $files) {
                    $content = Get-Content -Path $file.FullName -Raw

                    # Check for trailing whitespace
                    $lines = Get-Content -Path $file.FullName
                    for ($i = 0; $i -lt $lines.Count; $i++) {
                        if ($lines[$i] -match '\\s+$') {
                            $issues += "$($file.Name):$($i+1): Trailing whitespace"
                        }
                    }
                }

                if ($issues) {
                    Write-Host "Formatting issues found:"
                    $issues | ForEach-Object { Write-Host "  $_" }
                    Write-Warning "Please fix formatting issues"
                } else {
                    Write-Host "✓ No formatting issues found" -ForegroundColor Green
                }

        test:
          name: Unit Tests
          runs-on: windows-latest

          steps:
            - name: Harden the runner (Audit all outbound calls)
              uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
              with:
                egress-policy: audit

            - name: Checkout repository
              uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

            - name: Cache PowerShell modules
              uses: actions/cache@v4
              with:
                path: |
                  ~\Documents\PowerShell\Modules
                key: ps-modules-${{ runner.os }}-v1
                restore-keys: |
                  ps-modules-${{ runner.os }}-

            - name: Bootstrap dependencies
              uses: ./.github/actions/bootstrap

            - name: Run Pester tests
              shell: pwsh
              run: |
                # Ensure Pester is available (version 5.x)
                $pesterModule = Get-Module -ListAvailable -Name Pester | Sort-Object Version -Descending | Select-Object -First 1
                if (-not $pesterModule -or $pesterModule.Version -lt [version]'5.0.0') {
                    Install-Module -Name Pester -MinimumVersion 5.0.0 -Force -Scope CurrentUser -SkipPublisherCheck
                }

                Import-Module Pester -MinimumVersion 5.0.0

                # Configure Pester
                $config = New-PesterConfiguration
                $config.Run.Path = './src/Tests/Unit'
                $config.Run.PassThru = $true
                $config.Output.Verbosity = 'Detailed'
                $config.TestResult.Enabled = $true
                $config.TestResult.OutputPath = './TestResults.xml'
                $config.TestResult.OutputFormat = 'NUnitXml'

                # Run tests
                $result = Invoke-Pester -Configuration $config

                # Check results
                if ($result.FailedCount -gt 0) {
                    Write-Error "$($result.FailedCount) test(s) failed"
                    exit 1
                }

                Write-Host "✓ All tests passed ($($result.PassedCount) passed)" -ForegroundColor Green

            - name: Upload test results
              if: always()
              uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
              with:
                name: test-results-${{ github.run_number }}
                path: ./TestResults.xml
                retention-days: 30

#        build:
#          name: Build Module
#          runs-on: windows-latest
#          needs: [lint, test]

#          steps:
#            - name: Harden the runner (Audit all outbound calls)
#              uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
#              with:
#                egress-policy: audit

#            - name: Checkout repository
#              uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

#            - name: Cache PowerShell modules
#              uses: actions/cache@v4
#              with:
#                path: |
#                  ~\Documents\PowerShell\Modules
#                key: ps-modules-${{ runner.os }}-v1
#                restore-keys: |
#                  ps-modules-${{ runner.os }}-

#            - name: Bootstrap dependencies
#              uses: ./.github/actions/bootstrap

#            - name: Build module
#              shell: pwsh
#              run: |
#                # Check if Invoke-Build is available
#                if (-not (Get-Command Invoke-Build -ErrorAction SilentlyContinue)) {
#                    Install-Module -Name InvokeBuild -Force -Scope CurrentUser
#                }

#                # Run the build
#                $buildScript = "./src/DLLPickle.Build.ps1"
#                if (Test-Path $buildScript) {
#                    Write-Host "Running build script: $buildScript"
#                    Invoke-Build -File $buildScript -Task BuildNoIntegration
#                } else {
#                    Write-Warning "Build script not found: $buildScript"
#                }

#            - name: Upload build artifacts
#              if: success()
#              uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
#              with:
#                name: build-artifacts-${{ github.run_number }}
#                path: |
#                  ./src/Artifacts/**
#                  ./src/Archive/**
#                retention-days: 30

        summary:
          name: PR Summary
          runs-on: ubuntu-latest
          needs: [lint, test] #, build]
          if: always()

          steps:
            - name: Generate summary
              shell: pwsh
              run: |
                $summary = @"
                ## PR Checks Summary

                | Check | Status |
                |-------|--------|
                | Lint & Validate | ${{ needs.lint.result }} |
                | Tests | ${{ needs.test.result }} |

                **PR Number:** #${{ github.event.pull_request.number }}
                **Run ID:** ${{ github.run_id }}
                **Triggered by:** @${{ github.actor }}
                "@

                Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value $summary
