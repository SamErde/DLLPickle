name: Release and Publish

on:
  workflow_dispatch:
  #push:
  #  branches:
  #    - main
  #  paths:
  #    - 'src/DLLPickle/**'
  #    - '!src/Archive/**'
  #    - '!src/Artifacts/**'
  #    - '!**.md'

# Prevent concurrent releases
concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: read

jobs:
  check-version:
    name: Check Version and Conventional Commits
    runs-on: windows-latest
    # Skip if commit message contains [skip-release] or [no-release]
    if: |
      !contains(github.event.head_commit.message, '[skip-release]') &&
      !contains(github.event.head_commit.message, '[no-release]') &&
      github.repository_owner == 'SamErde'

    outputs:
      should_release: ${{ steps.version_check.outputs.should_release }}
      new_version: ${{ steps.version_check.outputs.new_version }}
      version_bump: ${{ steps.version_check.outputs.version_bump }}
      changelog_entry: ${{ steps.changelog.outputs.changelog_entry }}

    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0 # Need full history for conventional commits analysis

      - name: Analyze commits and determine version
        id: version_check
        shell: pwsh
        run: |
          $versionResult = & .\.github\scripts\Get-VersionBump.ps1

          "should_release=$($versionResult.ShouldRelease)" >> $env:GITHUB_OUTPUT
          "new_version=$($versionResult.NewVersion)" >> $env:GITHUB_OUTPUT
          "version_bump=$($versionResult.VersionBump)" >> $env:GITHUB_OUTPUT

      - name: Generate changelog entry
        id: changelog
        if: steps.version_check.outputs.should_release == 'true'
        shell: pwsh
        run: |
          # Get the last tag
          $lastTag = git describe --tags --abbrev=0 2>$null
          if (-not $lastTag) {
              $lastTag = (git rev-list --max-parents=0 HEAD)
          }

          # Get commits and organize by type
          $commits = git log "$lastTag..HEAD" --pretty=format:"%s|%h|%an" 2>$null

          $features = @()
          $fixes = @()
          $breaking = @()
          $other = @()

          foreach ($line in $commits) {
              $parts = $line -split '\|'
              $message = $parts[0]
              $hash = $parts[1]
              $author = $parts[2]

              if ($message -match 'BREAKING CHANGE:|!:') {
                  $breaking += "- $message (``$hash``)"
              } elseif ($message -match '^feat(\(.+\))?:') {
                  $features += "- $message (``$hash``)"
              } elseif ($message -match '^fix(\(.+\))?:') {
                  $fixes += "- $message (``$hash``)"
              } else {
                  $other += "- $message (``$hash``)"
              }
          }

          # Build changelog entry
          $changelogEntry = ""

          if ($breaking) {
              $changelogEntry += "### âš ï¸ BREAKING CHANGES`n`n"
              $changelogEntry += ($breaking -join "`n") + "`n`n"
          }

          if ($features) {
              $changelogEntry += "### âœ¨ Features`n`n"
              $changelogEntry += ($features -join "`n") + "`n`n"
          }

          if ($fixes) {
              $changelogEntry += "### ðŸ› Bug Fixes`n`n"
              $changelogEntry += ($fixes -join "`n") + "`n`n"
          }

          if ($other) {
              $changelogEntry += "### ðŸ”§ Other Changes`n`n"
              $changelogEntry += ($other -join "`n") + "`n`n"
          }

          # Write to output (handle multiline)
          $changelogEntry | Set-Content -Path changelog_temp.txt -NoNewline
          $encoded = [Convert]::ToBase64String([Text.Encoding]::UTF8.GetBytes($changelogEntry))
          "changelog_entry=$encoded" >> $env:GITHUB_OUTPUT

      - name: Display release plan
        if: steps.version_check.outputs.should_release == 'true'
        shell: pwsh
        run: |
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Cyan
          Write-Host "                    RELEASE PLAN                      " -ForegroundColor Cyan
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Cyan
          Write-Host "Version Bump: " -NoNewline
          Write-Host "${{ steps.version_check.outputs.version_bump }}" -ForegroundColor Green
          Write-Host "New Version:  " -NoNewline
          Write-Host "${{ steps.version_check.outputs.new_version }}" -ForegroundColor Green
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Cyan

  update-version:
    name: Update Module Manifest Version
    runs-on: windows-latest
    needs: check-version
    if: needs.check-version.outputs.should_release == 'true'

    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update module manifest
        shell: pwsh
        run: |
          $updateResult = & .\.github\scripts\Update-ModuleVersion.ps1 `
            -ManifestPath "./src/DLLPickle/DLLPickle.psd1" `
            -NewVersion "${{ needs.check-version.outputs.new_version }}"

          if (-not $updateResult.Success) {
            Write-Error $updateResult.ErrorMessage
            exit 1
          }

      - name: Commit version bump
        shell: pwsh
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add src/DLLPickle/DLLPickle.psd1
          git commit -m "chore(release): bump version to ${{ needs.check-version.outputs.new_version }} [skip-release]"
          git push

      - name: Create version tag
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $version = "${{ needs.check-version.outputs.new_version }}"
          $tag = "v$version"

          Write-Host "Checking if tag '$tag' already exists..."

          # Fetch tags from remote and check if tag exists locally after fetch
          Write-Host "Fetching tags from remote..."
          $fetchResult = git fetch --tags origin 2>&1
          if ($LASTEXITCODE -ne 0) {
              Write-Host "Warning: Failed to fetch tags from remote. Output:" -ForegroundColor Yellow
              Write-Host $fetchResult -ForegroundColor Yellow
          }

          # Check if tag exists locally (includes tags just fetched from remote)
          $tagExistsAfterFetch = git tag -l $tag

          if ($tagExistsAfterFetch) {
              Write-Host "âœ“ Tag '$tag' already exists, skipping tag creation (idempotent)" -ForegroundColor Yellow
              exit 0
          }

          Write-Host "Creating tag '$tag'..."

          # Configure git credential helper for authenticated push
          git config --local credential.helper ""
          git config --local --add credential.helper '!f() { echo "username=x-access-token"; echo "password=$env:GITHUB_TOKEN"; }; f'

          git tag -a $tag -m "Release version $version"
          git push origin $tag

          Write-Host "âœ“ Created and pushed tag: $tag" -ForegroundColor Green

  build-and-test:
    name: Build and Test Module
    runs-on: windows-latest
    needs: update-version

    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          ref: main # Get the latest with version bump

      - name: Bootstrap dependencies
        shell: pwsh
        run: |
          if (Test-Path ./.github/workflows/Actions_Bootstrap.ps1) {
              ./.github/workflows/Actions_Bootstrap.ps1
          }

      - name: Run build
        shell: pwsh
        run: |
          if (-not (Get-Command Invoke-Build -ErrorAction SilentlyContinue)) {
              Install-Module -Name InvokeBuild -Force -Scope CurrentUser
          }

          $buildScript = "./src/DLLPickle.build.ps1"
          if (Test-Path $buildScript) {
              Invoke-Build -File $buildScript
          }

      - name: Upload build artifacts
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: release-artifacts-${{ github.run_number }}
          path: |
            ./src/Artifacts/**
            ./src/Archive/**
          retention-days: 90

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [check-version, build-and-test]

    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          ref: main
          fetch-depth: 0  # Fetch full history and tags
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Ensure tag exists
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $version = "${{ needs.check-version.outputs.new_version }}"
          $tag = "v$version"

          Write-Host "Ensuring tag '$tag' exists for release creation..."

          # Fetch all tags from remote
          # Note: stderr is suppressed intentionally as git fetch may output warnings
          Write-Host "Fetching remote tags..."
          git fetch --tags origin 2>&1 | Out-Null

          # Check if tag exists
          $tagExists = git tag -l $tag
          if ($tagExists) {
              Write-Host "âœ“ Tag '$tag' exists locally" -ForegroundColor Green
              exit 0
          }

          Write-Host "Tag '$tag' not found locally, checking remote..."

          # Try to fetch the specific tag
          # Note: This may fail if tag doesn't exist, which is expected
          Write-Host "Attempting to fetch specific tag: $tag"
          git fetch origin "refs/tags/$tag:refs/tags/$tag" 2>&1 | Out-Null
          if ($LASTEXITCODE -eq 0) {
              Write-Host "âœ“ Successfully fetched tag from remote" -ForegroundColor Green
          } else {
              Write-Host "Tag not found on remote (expected if creating new release)"
          }
          $tagExists = git tag -l $tag

          if ($tagExists) {
              Write-Host "âœ“ Tag '$tag' fetched from remote" -ForegroundColor Green
              exit 0
          }

          Write-Host "Tag '$tag' not found on remote, creating it now..."

          # Configure git credential helper to securely supply GITHUB_TOKEN
          # Note: This authentication logic is intentionally duplicated from update-version job for reliability/isolation
          git config --local credential.helper ""
          git config --local --add credential.helper '!f() { echo "username=x-access-token"; echo "password=$env:GITHUB_TOKEN"; }; f'

          # Create and push the tag (defensive - in case update-version job's tag push failed)
          $localTag = git tag -l $tag
          if (-not $localTag) {
              git tag -a $tag -m "Release version $version"
              Write-Host "âœ“ Created tag locally: $tag" -ForegroundColor Green
          } else {
              Write-Host "Tag '$tag' already exists locally, will attempt to push" -ForegroundColor Yellow
          }

          # Push tag with error handling for race conditions
          $pushResult = git push origin $tag 2>&1
          if ($LASTEXITCODE -eq 0) {
              Write-Host "âœ“ Successfully pushed tag: $tag" -ForegroundColor Green
          } else {
              # Tag may already exist remotely (race condition or previous successful push)
              Write-Host "âš  Tag push returned non-zero exit code. This may be expected if tag already exists remotely." -ForegroundColor Yellow
              Write-Host "Push output: $pushResult" -ForegroundColor Yellow
          }

      - name: Decode changelog
        id: decode
        shell: pwsh
        run: |
          $encoded = "${{ needs.check-version.outputs.changelog_entry }}"
          $decoded = [Text.Encoding]::UTF8.GetString([Convert]::FromBase64String($encoded))
          $decoded | Set-Content -Path changelog_decoded.txt -NoNewline
          Write-Host "Changelog decoded and saved"

      - name: Check if release exists
        id: check_release
        shell: pwsh
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          $version = "${{ needs.check-version.outputs.new_version }}"
          $tag = "v$version"

          try {
              $output = gh release view $tag --json tagName 2>&1
              if ($LASTEXITCODE -eq 0) {
                  Write-Host "Release $tag already exists"
                  "exists=true" >> $env:GITHUB_OUTPUT
              } else {
                  Write-Host "Release $tag does not exist"
                  "exists=false" >> $env:GITHUB_OUTPUT
              }
          } catch {
              Write-Host "Release $tag does not exist"
              "exists=false" >> $env:GITHUB_OUTPUT
          }

      - name: Update CHANGELOG.md
        if: steps.check_release.outputs.exists == 'false'
        shell: pwsh
        run: |
          $version = "${{ needs.check-version.outputs.new_version }}"
          $date = Get-Date -Format "yyyy-MM-dd"
          $changelogPath = "./CHANGELOG.md"

          $newEntry = Get-Content changelog_decoded.txt -Raw

          # Read existing changelog
          if (Test-Path $changelogPath) {
              $changelog = Get-Content $changelogPath -Raw
          } else {
              $changelog = "# Changelog`n`nAll notable changes to this project will be documented in this file.`n`n"
          }

          # Insert new entry after the header
          $header = "# Changelog`n`nAll notable changes to this project will be documented in this file.`n`n"
          $newSection = "## [$version] - $date`n`n$newEntry`n"

          if ($changelog -match '# Changelog') {
              $changelog = $changelog -replace '(# Changelog.*?\n\n)', "`$1$newSection"
          } else {
              $changelog = $header + $newSection + $changelog
          }

          $changelog | Set-Content -Path $changelogPath -NoNewline
          Write-Host "âœ“ CHANGELOG.md updated" -ForegroundColor Green

      - name: Commit changelog
        if: steps.check_release.outputs.exists == 'false'
        shell: pwsh
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add CHANGELOG.md
          git commit -m "docs(changelog): update for version ${{ needs.check-version.outputs.new_version }} [skip-release]"
          git push

      - name: Create GitHub release
        if: steps.check_release.outputs.exists == 'false'
        shell: pwsh
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          $version = "${{ needs.check-version.outputs.new_version }}"
          $tag = "v$version"
          $title = "DLLPickle v$version"

          $changelogContent = Get-Content changelog_decoded.txt -Raw

          $releaseBody = @"
          ## What's Changed

          $changelogContent

          ### ðŸ“¦ Installation

          ``````powershell
          Install-Module -Name DLLPickle -RequiredVersion $version
          ``````

          ### ðŸ“‹ Links
          - **PowerShell Gallery:** https://www.powershellgallery.com/packages/DLLPickle/$version
          - **Full Changelog:** https://github.com/$env:GITHUB_REPOSITORY/blob/main/CHANGELOG.md
          "@

          # Create release
          gh release create $tag --title $title --notes $releaseBody

          Write-Host "âœ“ GitHub release created: $tag" -ForegroundColor Green

  publish:
    name: Publish to PowerShell Gallery
    runs-on: windows-latest
    needs: [check-version, create-release]
    environment:
      name: psgallery
      url: https://www.powershellgallery.com/packages/DLLPickle

    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          ref: main

      - name: Setup PowerShell environment
        shell: pwsh
        run: |
          Write-Host "PowerShell Version: $($PSVersionTable.PSVersion)"
          Set-PSRepository -Name PSGallery -InstallationPolicy Trusted

      - name: Check if version exists on PSGallery
        id: check_psgallery
        shell: pwsh
        run: |
          $version = "${{ needs.check-version.outputs.new_version }}"

          try {
              $existing = Find-Module -Name DLLPickle -RequiredVersion $version -ErrorAction SilentlyContinue
              if ($existing) {
                  Write-Host "Version $version already exists on PSGallery"
                  "exists=true" >> $env:GITHUB_OUTPUT
              } else {
                  Write-Host "Version $version not found on PSGallery"
                  "exists=false" >> $env:GITHUB_OUTPUT
              }
          } catch {
              Write-Host "Version $version not found on PSGallery"
              "exists=false" >> $env:GITHUB_OUTPUT
          }

      - name: Publish to PowerShell Gallery
        if: steps.check_psgallery.outputs.exists == 'false'
        shell: pwsh
        env:
          PSGALLERY_API_KEY: ${{ secrets.PSGALLERY_API_KEY }}
        run: |
          if ([string]::IsNullOrWhiteSpace($env:PSGALLERY_API_KEY)) {
              Write-Error "PSGALLERY_API_KEY secret is not set"
              exit 1
          }

          $publishResult = & .\.github\scripts\Publish-ToGallery.ps1 `
            -ModuleDirectory "./src/DLLPickle" `
            -ApiKey $env:PSGALLERY_API_KEY

          if (-not $publishResult.Success) {
              Write-Error "Publishing failed: $($publishResult.Message)"
              exit 1
          }

      - name: Verify publication
        if: steps.check_psgallery.outputs.exists == 'false'
        shell: pwsh
        run: |
          $version = "${{ needs.check-version.outputs.new_version }}"

          Write-Host "Waiting for PSGallery indexing..."
          Start-Sleep -Seconds 30

          $published = Find-Module -Name DLLPickle -RequiredVersion $version -ErrorAction SilentlyContinue
          if ($published) {
              Write-Host "âœ“ Module is now visible on PowerShell Gallery" -ForegroundColor Green
          } else {
              Write-Warning "Module published but not yet visible in search (indexing may take time)"
          }

  summary:
    name: Release Summary
    runs-on: ubuntu-latest
    needs: [check-version, update-version, build-and-test, create-release, publish]
    if: always()

    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Generate summary
        shell: pwsh
        run: |
          $summary = @"
          ## ðŸš€ Release Summary

          **Version:** ${{ needs.check-version.outputs.new_version }}
          **Version Bump:** ${{ needs.check-version.outputs.version_bump }}

          | Step | Status |
          |------|--------|
          | Version Check | ${{ needs.check-version.result }} |
          | Update Version | ${{ needs.update-version.result }} |
          | Build & Test | ${{ needs.build-and-test.result }} |
          | GitHub Release | ${{ needs.create-release.result }} |
          | PSGallery Publish | ${{ needs.publish.result }} |

          ### ðŸ“¦ Links
          - **Release:** https://github.com/$env:GITHUB_REPOSITORY/releases/tag/v${{ needs.check-version.outputs.new_version }}
          - **PowerShell Gallery:** https://www.powershellgallery.com/packages/DLLPickle/${{ needs.check-version.outputs.new_version }}
          - **Run ID:** ${{ github.run_id }}

          ---
          _Triggered by @${{ github.actor }} on push to main_
          "@

          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value $summary
